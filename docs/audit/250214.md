# Talentify Audit 2025-02-14

## Issue 1: Offer update authorization mismatch
- **Cause**: `/api/offers/[id]` compared `auth.user.id` with `offers.store_id` and `offers.talent_id` (both are entity IDs, not user IDs), resulting in false negatives.
- **Reproduction**: Logged-in store owner attempts to update contract URL via `PUT /api/offers/{id}` → receives `403 権限がありません`.
- **Impact**: Store owners and talents cannot update offers (contract, invoice info) despite having privileges.
- **Fix**: Fetch related `stores.user_id` and `talents.user_id` then compare with `auth.user.id`.
- **Checks**: `npm test`, `npm run lint`.

## Issue 2: Notifications cannot be marked as read
- **Cause**: RLS policies for `notifications` allow only `INSERT` (service role) and `SELECT` (receiver). `utils/notifications.ts::markNotificationRead` performs `UPDATE`, which violates RLS.
- **Reproduction**: Call `markNotificationRead(id)` as a normal user → `new row violates row-level security policy for table "notifications"`.
- **Impact**: Users cannot mark notifications as read; notification badges never clear.
- **Workaround**: Use service role (not recommended).
- **Proposed SQL**: `supabase-sql-proposals/20250214_notifications_update.sql`.

## RLS Mapping (excerpt)
| Table | Operation | Code Path | RLS Policy |
|-------|-----------|-----------|------------|
| offers | INSERT | `app/api/offers/route.ts` (POST) | `offers_insert_by_store`
| offers | UPDATE (store) | `app/api/offers/[id]/route.ts` (store block) | `offers_update_by_store`
| offers | UPDATE (talent) | `app/api/offers/[id]/route.ts` (talent block), `talent_accept_offer` RPC | `talent_update_own_offer_status`
| notifications | UPDATE | `utils/notifications.ts::markNotificationRead` | **missing** → add `notifications_update_self` |

## Schema / Type mismatches
| Location | Field | Mismatch |
|----------|-------|----------|
| `supabase-docs/schema.md` vs generated types | `notifications.title`, `notifications.body` | Columns exist in DB and code but were missing in docs (docs updated) |

## Confirmation checklist
1. Store user can create an offer via `POST /api/offers`.
2. Store user can update status or contract via `PUT /api/offers/{id}`.
3. Talent user can update invoice fields via `PUT /api/offers/{id}`.
4. After applying proposed SQL, `markNotificationRead` updates notification without RLS error.

